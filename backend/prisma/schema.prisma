generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model customers {
  id                 Int                  @id @default(autoincrement())
  name               String               @db.VarChar(255)
  phone              String?              @db.VarChar(50)
  email              String?              @db.VarChar(255)
  address            String?
  created_at         DateTime?            @default(now()) @db.Timestamp(6)
  updated_at         DateTime?            @default(now()) @db.Timestamp(6)
  balance            Decimal?             @default(0) @db.Decimal(10, 2)
  folder_id          Int?
  code               String?              @db.VarChar(50)
  is_active          Boolean?             @default(true)
  type               String?              @default("BUYER") @db.VarChar(20) // BUYER, SUPPLIER, BOTH
  folder             customer_folders?    @relation(fields: [folder_id], references: [id], onUpdate: NoAction)
  sale_invoices      sale_invoices[]
  customer_discounts customer_discounts[]
  permanent_discount Decimal?             @default(0) @db.Decimal(5, 2)
  purchase_invoices  purchase_invoices[]
}

model customer_discounts {
  id          Int       @id @default(autoincrement())
  customer_id Int
  percentage  Decimal   @db.Decimal(5, 2)
  start_date  DateTime  @db.Timestamp(6)
  end_date    DateTime  @db.Timestamp(6)
  is_active   Boolean?  @default(true)
  created_at  DateTime? @default(now()) @db.Timestamp(6)
  customer    customers @relation(fields: [customer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model product_discounts {
  id         Int       @id @default(autoincrement())
  product_id Int
  percentage Decimal   @db.Decimal(5, 2)
  start_date DateTime  @db.Timestamp(6)
  end_date   DateTime  @db.Timestamp(6)
  is_active  Boolean?  @default(true)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  product    products  @relation(fields: [product_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model password_reset_tokens {
  id         Int       @id @default(autoincrement())
  user_id    Int?
  token      String    @unique @db.VarChar(255)
  expires_at DateTime  @db.Timestamp(6)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  users      users?    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model categories {
  id         Int          @id @default(autoincrement())
  name       String       @db.VarChar(255)
  parent_id  Int?
  created_at DateTime?    @default(now()) @db.Timestamp(6)
  updated_at DateTime?    @default(now()) @db.Timestamp(6)
  parent     categories?  @relation("CategoryTree", fields: [parent_id], references: [id], onUpdate: NoAction)
  children   categories[] @relation("CategoryTree")
  products   products[]
}

model products {
  id                      Int                       @id @default(autoincrement())
  name                    String                    @db.VarChar(255)
  barcode                 String?                   @db.VarChar(100)
  description             String?
  unit                    String?                   @default("ədəd") @db.VarChar(50)
  purchase_price          Decimal?                  @default(0) @db.Decimal(10, 2)
  sale_price              Decimal?                  @default(0) @db.Decimal(10, 2)
  created_at              DateTime?                 @default(now()) @db.Timestamp(6)
  updated_at              DateTime?                 @default(now()) @db.Timestamp(6)
  code                    String?                   @db.VarChar(20)
  article                 String?                   @db.VarChar(100)
  category_id             Int?
  type                    String?                   @db.VarChar(100)
  brand                   String?                   @db.VarChar(100)
  model                   String?                   @db.VarChar(100)
  color                   String?                   @db.VarChar(50)
  size                    String?                   @db.VarChar(50)
  weight                  Decimal?                  @db.Decimal(10, 2)
  country                 String?                   @db.VarChar(100)
  manufacturer            String?                   @db.VarChar(255)
  warranty_period         Int?
  min_stock               Decimal?                  @default(0) @db.Decimal(10, 2)
  max_stock               Decimal?                  @db.Decimal(10, 2)
  tax_rate                Decimal?                  @default(0) @db.Decimal(5, 2)
  is_active               Boolean?                  @default(true)
  production_date         DateTime?                 @db.Timestamp(6)
  expiry_date             DateTime?                 @db.Timestamp(6)
  category                categories?               @relation(fields: [category_id], references: [id], onUpdate: NoAction)
  purchase_invoice_items  purchase_invoice_items[]
  sale_invoice_items      sale_invoice_items[]
  warehouse               warehouse[]
  product_discounts       product_discounts[]
  discount_document_items discount_document_items[]
}

model purchase_invoice_items {
  id                Int                @id @default(autoincrement())
  invoice_id        Int?
  product_id        Int?
  quantity          Decimal            @db.Decimal(10, 2)
  unit_price        Decimal            @db.Decimal(10, 2)
  total_price       Decimal            @db.Decimal(10, 2)
  discount_auto     Decimal?           @default(0) @db.Decimal(5, 2)
  discount_manual   Decimal?           @default(0) @db.Decimal(5, 2)
  purchase_invoices purchase_invoices? @relation(fields: [invoice_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  products          products?          @relation(fields: [product_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model purchase_invoices {
  id                     Int                      @id @default(autoincrement())
  invoice_number         String                   @unique @db.VarChar(100)
  supplier_id            Int? // Deprecated - use customer_id instead
  customer_id            Int? // New field - references customers table
  total_amount           Decimal?                 @default(0) @db.Decimal(10, 2)
  invoice_date           DateTime?                @default(now()) @db.Timestamp(6)
  payment_date           DateTime?                @db.Timestamp(6)
  notes                  String?
  created_at             DateTime?                @default(now()) @db.Timestamp(6)
  is_active              Boolean?                 @default(true)
  purchase_invoice_items purchase_invoice_items[]
  suppliers              suppliers?               @relation(fields: [supplier_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  customer               customers?               @relation(fields: [customer_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model sale_invoice_items {
  id              Int            @id @default(autoincrement())
  invoice_id      Int?
  product_id      Int?
  quantity        Decimal        @db.Decimal(10, 2)
  unit_price      Decimal        @db.Decimal(10, 2)
  total_price     Decimal        @db.Decimal(10, 2)
  discount_auto   Decimal?       @default(0) @db.Decimal(5, 2)
  discount_manual Decimal?       @default(0) @db.Decimal(5, 2)
  sale_invoices   sale_invoices? @relation(fields: [invoice_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  products        products?      @relation(fields: [product_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model sale_invoices {
  id                 Int                  @id @default(autoincrement())
  invoice_number     String               @unique @db.VarChar(100)
  customer_id        Int?
  total_amount       Decimal?             @default(0) @db.Decimal(10, 2)
  invoice_date       DateTime?            @default(now()) @db.Timestamp(6)
  notes              String?
  created_at         DateTime?            @default(now()) @db.Timestamp(6)
  payment_date       DateTime?            @db.Timestamp(6)
  is_active          Boolean?             @default(true)
  sale_invoice_items sale_invoice_items[]
  customers          customers?           @relation(fields: [customer_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model suppliers {
  id                 Int                 @id @default(autoincrement())
  name               String              @db.VarChar(255)
  phone              String?             @db.VarChar(50)
  email              String?             @db.VarChar(255)
  address            String?
  created_at         DateTime?           @default(now()) @db.Timestamp(6)
  updated_at         DateTime?           @default(now()) @db.Timestamp(6)
  balance            Decimal?            @default(0) @db.Decimal(10, 2)
  permanent_discount Decimal?            @default(0) @db.Decimal(5, 2)
  purchase_invoices  purchase_invoices[]
}

model users {
  id                    Int                     @id @default(autoincrement())
  email                 String                  @unique @db.VarChar(255)
  password              String                  @db.VarChar(255)
  created_at            DateTime?               @default(now()) @db.Timestamp(6)
  updated_at            DateTime?               @default(now()) @db.Timestamp(6)
  full_name             String?                 @db.VarChar(255)
  role                  String?                 @default("USER") @db.VarChar(50)
  is_admin              Boolean?                @default(false)
  is_active             Boolean?                @default(true)
  activity_logs         activity_logs[]
  password_reset_tokens password_reset_tokens[]
  notifications         notifications[]
}

model warehouse {
  id         Int       @id @default(autoincrement())
  product_id Int?
  quantity   Decimal?  @default(0) @db.Decimal(10, 2)
  updated_at DateTime? @default(now()) @db.Timestamp(6)
  products   products? @relation(fields: [product_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model customer_folders {
  id         Int                @id @default(autoincrement())
  name       String             @db.VarChar(255)
  parent_id  Int?
  created_at DateTime?          @default(now()) @db.Timestamp(6)
  updated_at DateTime?          @default(now()) @db.Timestamp(6)
  parent     customer_folders?  @relation("CustomerFolderTree", fields: [parent_id], references: [id], onUpdate: NoAction)
  children   customer_folders[] @relation("CustomerFolderTree")
  customers  customers[]
}

model activity_logs {
  id         Int       @id @default(autoincrement())
  log_id     String    @unique @db.VarChar(255)
  user_id    Int?
  timestamp  DateTime  @db.Timestamp(6)
  level      String    @db.VarChar(20)
  category   String    @db.VarChar(50)
  action     String
  details    String?
  metadata   Json?
  created_at DateTime? @default(now()) @db.Timestamp(6)
  user       users?    @relation(fields: [user_id], references: [id], onUpdate: NoAction)

  @@index([category], map: "idx_activity_logs_category")
  @@index([timestamp], map: "idx_activity_logs_timestamp")
  @@index([user_id], map: "idx_activity_logs_user_id")
  @@index([category], map: "idx_logs_category")
  @@index([level], map: "idx_logs_level")
  @@index([log_id], map: "idx_logs_log_id")
  @@index([user_id, timestamp(sort: Desc)], map: "idx_logs_user_timestamp")
}

model discount_documents {
  id              Int                       @id @default(autoincrement())
  document_number String                    @unique @db.VarChar(100)
  document_date   DateTime                  @db.Timestamp(6) // Keep for reference? Or user wants to replace? User said "tarixi secende iki tarix olmalidi". "When selecting date".
  // I will keep document_date as "Document Date" (paper date) and add validity.
  start_date      DateTime?                 @default(now()) @db.Timestamp(6)
  end_date        DateTime?                 @default(now()) @db.Timestamp(6)
  type            String                    @db.VarChar(20) // 'SUPPLIER' or 'PRODUCT'
  entity_id       Int? // Supplier ID or Product ID
  is_active       Boolean?                  @default(true)
  notes           String?
  created_at      DateTime?                 @default(now()) @db.Timestamp(6)
  items           discount_document_items[]
}

model discount_document_items {
  id               Int                @id @default(autoincrement())
  document_id      Int
  product_id       Int?
  discount_percent Decimal            @db.Decimal(5, 2)
  description      String?
  document         discount_documents @relation(fields: [document_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  product          products?          @relation(fields: [product_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

// Trigger restart

model notifications {
  id         Int       @id @default(autoincrement())
  user_id    Int
  type       String    @db.VarChar(20)
  title      String    @db.VarChar(255)
  message    String
  timestamp  DateTime  @default(now()) @db.Timestamp(6)
  read       Boolean?  @default(false)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  user       users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id, timestamp(sort: Desc)], map: "idx_notifications_user_timestamp")
  @@index([user_id, read], map: "idx_notifications_user_read")
  @@index([type], map: "idx_notifications_type")
}
